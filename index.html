<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>גיליון רישום שעות עבודה (מסונכרן)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #111827; /* Dark background */
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-200">
    <div class="max-w-6xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-lg border border-gray-700">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-white">גיליון רישום שעות עבודה</h1>
            <p class="text-gray-400 mt-2">הנתונים שלך מסונכרנים אוטומטית בין כל המכשירים</p>
        </header>

        <div id="loading" class="text-center py-8 text-gray-400">טוען נתונים...</div>

        <div class="table-container border border-gray-700 rounded-lg hidden">
            <table class="w-full text-sm text-right text-gray-300">
                <thead class="text-xs text-gray-400 uppercase bg-gray-800 sticky top-0">
                    <tr>
                        <th scope="col" class="px-6 py-3">תאריך</th>
                        <th scope="col" class="px-6 py-3">בית ספר / לקוח</th>
                        <th scope="col" class="px-6 py-3">תעריף לשעה (₪)</th>
                        <th scope="col" class="px-6 py-3">שעות עבודה</th>
                        <th scope="col" class="px-6 py-3">הערות</th>
                        <th scope="col" class="px-6 py-3">סה"כ יומי (₪)</th>
                        <th scope="col" class="px-6 py-3">פעולות</th>
                    </tr>
                </thead>
                <tbody id="timesheet-body">
                    <!-- Rows are rendered here by Firebase -->
                </tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-between items-center flex-wrap gap-4">
             <button id="add-row-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">הוסף שורה</button>
            <div id="totals" class="flex items-center gap-6 bg-gray-800 p-4 rounded-lg shadow-inner border border-gray-700">
                <div class="text-center">
                    <span class="text-sm text-gray-400 block">סה"כ שעות</span>
                    <span id="total-hours" class="text-xl font-bold text-white">0.00</span>
                </div>
                <div class="text-center">
                    <span class="text-sm text-gray-400 block">סה"כ לתשלום</span>
                    <span id="total-payment" class="text-xl font-bold text-green-400">0.00 ₪</span>
                </div>
            </div>
        </div>
         <p class="text-xs text-center text-gray-500 mt-4">מזהה משתמש: <span id="user-id" class="font-mono bg-gray-700 p-1 rounded"></span></p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // DOM Elements
        const timesheetBody = document.getElementById('timesheet-body');
        const addRowBtn = document.getElementById('add-row-btn');
        const totalHoursEl = document.getElementById('total-hours');
        const totalPaymentEl = document.getElementById('total-payment');
        const loadingEl = document.getElementById('loading');
        const tableContainer = document.querySelector('.table-container');
        const userIdEl = document.getElementById('user-id');

        // Firebase Setup
        let db, auth, userId, timesheetCollectionRef;
        const renderedRows = new Map(); 

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-timesheet-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            loadingEl.textContent = "שגיאה בהתחברות לשירות הסנכרון.";
        }
        
        // Authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdEl.textContent = userId.substring(0, 10) + '...';
                const collectionPath = `artifacts/${appId}/users/${userId}/timesheet_entries`;
                timesheetCollectionRef = collection(db, collectionPath);
                listenForDataChanges();
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication Error:", error);
                    loadingEl.textContent = "שגיאת התחברות.";
                }
            }
        });

        // Realtime Data Listener
        function listenForDataChanges() {
            const q = query(timesheetCollectionRef);
            onSnapshot(q, (snapshot) => {
                loadingEl.style.display = 'none';
                tableContainer.classList.remove('hidden');

                const docIdsOnServer = new Set(snapshot.docs.map(d => d.id));
                
                snapshot.docs.forEach(doc => {
                    if (!renderedRows.has(doc.id)) {
                        createAndAppendRow(doc.data(), doc.id);
                    }
                });
                
                renderedRows.forEach((row, id) => {
                    if (!docIdsOnServer.has(id)) {
                        row.remove();
                        renderedRows.delete(id);
                    }
                });

                calculateGrandTotals();
            }, (error) => {
                console.error("Error fetching data:", error);
                loadingEl.textContent = "שגיאה בטעינת הנתונים.";
            });
        }

        // DOM Manipulation
        function createAndAppendRow(data, id) {
            const row = document.createElement('tr');
            row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700/50 fade-in';
            row.dataset.id = id;

            row.innerHTML = `
                <td class="px-6 py-4"><input type="date" class="w-full bg-gray-700 text-white border-gray-600 rounded-md p-1 focus:ring-blue-500 focus:border-blue-500" value="${data.date || ''}"></td>
                <td class="px-6 py-4"><input type="text" placeholder="שם הלקוח" class="w-full bg-gray-700 text-white border-gray-600 rounded-md p-1 focus:ring-blue-500 focus:border-blue-500" value="${data.client || ''}"></td>
                <td class="px-6 py-4"><input type="number" step="0.01" min="0" placeholder="0.00" class="w-20 bg-gray-700 text-white border-gray-600 rounded-md p-1 focus:ring-blue-500 focus:border-blue-500 rate" value="${data.rate || ''}"></td>
                <td class="px-6 py-4"><input type="number" step="0.01" min="0" placeholder="0.00" class="w-20 bg-gray-700 text-white border-gray-600 rounded-md p-1 focus:ring-blue-500 focus:border-blue-500 hours" value="${data.hours || ''}"></td>
                <td class="px-6 py-4"><input type="text" placeholder="הוסף הערה..." class="w-full bg-gray-700 text-white border-gray-600 rounded-md p-1 focus:ring-blue-500 focus:border-blue-500" value="${data.notes || ''}"></td>
                <td class="px-6 py-4 font-semibold text-white daily-total">${((data.rate || 0) * (data.hours || 0)).toFixed(2)}</td>
                <td class="px-6 py-4">
                    <button class="delete-btn text-red-500 hover:text-red-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </td>
            `;

            row.addEventListener('input', debounce(() => updateRowInDB(id, row), 500));
            row.querySelector('.delete-btn').addEventListener('click', () => deleteRowFromDB(id));
            
            timesheetBody.appendChild(row);
            renderedRows.set(id, row);
        }

        // Database Operations
        const addRowToDB = async () => {
            if (!userId) return;
            await addDoc(timesheetCollectionRef, {
                date: new Date().toISOString().split('T')[0],
                client: '',
                rate: 0,
                hours: 0,
                notes: '',
            });
        };

        const updateRowInDB = async (id, rowElement) => {
            const dataToUpdate = {
                date: rowElement.querySelector('input[type="date"]').value,
                client: rowElement.querySelector('input[type="text"]').value,
                rate: parseFloat(rowElement.querySelector('.rate').value) || 0,
                hours: parseFloat(rowElement.querySelector('.hours').value) || 0,
                notes: rowElement.querySelector('input[type="text"]:last-of-type').value,
            };
            
            const rate = dataToUpdate.rate;
            const hours = dataToUpdate.hours;
            rowElement.querySelector('.daily-total').textContent = (rate * hours).toFixed(2);
            calculateGrandTotals();
            
            const docRef = doc(db, timesheetCollectionRef.path, id);
            await updateDoc(docRef, dataToUpdate);
        };

        const deleteRowFromDB = async (id) => {
            const docRef = doc(db, timesheetCollectionRef.path, id);
            await deleteDoc(docRef);
        };

        // Calculations & Utilities
        const calculateGrandTotals = () => {
            let totalHours = 0;
            let totalPayment = 0;
            renderedRows.forEach(row => {
                totalHours += parseFloat(row.querySelector('.hours').value) || 0;
                totalPayment += parseFloat(row.querySelector('.daily-total').textContent) || 0;
            });
            totalHoursEl.textContent = totalHours.toFixed(2);
            totalPaymentEl.textContent = `${totalPayment.toFixed(2)} ₪`;
        };
        
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        };

        // Event Listeners
        addRowBtn.addEventListener('click', addRowToDB);
    </script>
</body>
</html>


